<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
 <style>
  .return-header {
    margin-bottom: 2rem;
  }

  .return-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }

  .return-card {
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
  }

  .return-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
  }

  .equipment-image-section {
    width: 100%;
    height: 180px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  .equipment-image-section img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .equipment-image-section .no-image {
    color: white;
    font-size: 3rem;
  }

  .return-body {
    padding: 1.5rem;
  }

  .equipment-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .equipment-title i {
    color: #667eea;
  }

  .info-list {
    display: grid;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .info-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    font-size: 0.9rem;
  }

  .info-row i {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #667eea;
    color: white;
    border-radius: 50%;
    font-size: 0.8rem;
    flex-shrink: 0;
  }

  .info-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .info-text {
    flex: 1;
  }

  .info-label {
    color: #6c757d;
    font-size: 0.75rem;
  }

  .info-value {
    color: #2c3e50;
    font-weight: 500;
  }

  .status-section {
    margin-bottom: 1.5rem;
  }

  .status-badge-large {
    width: 100%;
    padding: 1rem;
    border-radius: 0.5rem;
    font-size: 0.95rem;
    font-weight: 500;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .status-borrowed {
    background: #d4edda;
    color: #155724;
    border: 2px solid #28a745;
  }

  .status-pending {
    background: #fff3cd;
    color: #856404;
    border: 2px solid #ffc107;
  }

  .status-badge-large i {
    font-size: 1.1rem;
  }

  .return-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn-return {
    flex: 1;
    padding: 0.75rem;
    font-weight: 500;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .empty-state i {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    color: #495057;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: #6c757d;
    margin-bottom: 1.5rem;
  }
</style>

<div class="return-header">
  <h1 class="page-title mb-2">คืนอุปกรณ์</h1>
  <p class="text-muted">รายการอุปกรณ์ที่คุณกำลังยืมอยู่</p>
</div>

<% if (locals.alert) { %>
  <div class="alert alert-<%= alert.type %> alert-dismissible fade show" role="alert">
    <strong><%= alert.title %></strong> <%= alert.message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (!borrowedItems || borrowedItems.length === 0) { %>
  <div class="empty-state">
    <i class="bi bi-inbox"></i>
    <h3>ไม่มีอุปกรณ์ที่ต้องคืน</h3>
    <p>คุณไม่มีอุปกรณ์ที่กำลังยืมอยู่ในขณะนี้</p>
  </div>
<% } else { %>
  <div class="return-grid">
    <% borrowedItems.forEach(item => { %>
      <div class="return-card" id="card-<%= item._id %>">
        <div class="equipment-image-section">
          <% if (item.equipment_id && item.equipment_id.image) { %>
            <img src="<%= item.equipment_id.image %>" alt="<%= item.equipment_id.name %>">
          <% } else { %>
            <div class="no-image">
              <i class="bi bi-box-seam"></i>
            </div>
          <% } %>
        </div>

        <div class="return-body">
          <div class="equipment-title">
            <i class="bi bi-box-seam"></i>
            <span><%= item.equipment_id ? item.equipment_id.name : 'อุปกรณ์ถูกลบ' %></span>
          </div>

          <div class="info-list">
            <!-- วันที่ยืม -->
            <div class="info-row">
              <i class="bi bi-calendar3"></i>
              <div>
                <div class="info-label">วันที่ยืม</div>
                <div class="info-value">
                  <%= item.created_at ? new Date(item.created_at).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  }) : '-' %>
                </div>
              </div>
            </div>

            <!-- วันที่คืน -->
            <div class="info-row">
              <i class="bi bi-calendar-check"></i>
              <div>
                <div class="info-label">วันที่คืน</div>
                <div class="info-value">
                  <%= item.return_date ? new Date(item.return_date).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  }) : '-' %>
                </div>
              </div>
            </div>
          </div>

          <div class="status-section">
            <div class="status-badge-large status-display <%= item.status === 'Borrowed' ? 'status-borrowed' : 'status-pending' %>">
              <% if (item.status === 'Borrowed') { %>
                <i class="bi bi-box-seam"></i>
                <span>กำลังยืมอยู่</span>
              <% } else if (item.status === 'PendingReturn') { %>
                <i class="bi bi-hourglass-split"></i>
                <span>รออนุมัติการคืน</span>
              <% } %>
            </div>
          </div>

          <div class="return-actions">
            <% if (item.status === 'Borrowed') { %>
              <button class="btn btn-primary btn-return return-btn" data-id="<%= item._id %>">
                <i class="bi bi-box-arrow-in-down me-2"></i>ขอคืนอุปกรณ์
              </button>
            <% } else if (item.status === 'PendingReturn') { %>
              <button class="btn btn-secondary btn-return" disabled>
                <i class="bi bi-clock-history me-2"></i>รอแอดมินอนุมัติ
              </button>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.querySelectorAll('.return-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const id = btn.dataset.id;

    const confirm = await Swal.fire({
      title: 'ยืนยันการคืนอุปกรณ์?',
      text: 'คุณต้องการขอคืนอุปกรณ์นี้หรือไม่?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ใช่, ขอคืน',
      cancelButtonText: 'ยกเลิก',
      confirmButtonColor: '#667eea',
      cancelButtonColor: '#6c757d',
      reverseButtons: true
    });

    if (!confirm.isConfirmed) return;

    try {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>กำลังดำเนินการ...';

      const res = await fetch(`/users/returnEquipment/${id}`, { method: 'POST' });
      const data = await res.json();

      if (res.ok && data.success) {
        await Swal.fire({
          icon: 'success',
          title: 'ส่งคำขอคืนเรียบร้อย!',
          text: 'รอแอดมินอนุมัติการคืนอุปกรณ์',
          confirmButtonColor: '#667eea',
          timer: 2000,
          timerProgressBar: true
        });

        // อัปเดต Card
        const card = document.getElementById('card-' + id);
        if (card) {
          const statusDisplay = card.querySelector('.status-display');
          statusDisplay.className = 'status-badge-large status-display status-pending';
          statusDisplay.innerHTML = '<i class="bi bi-hourglass-split"></i><span>รออนุมัติการคืน</span>';

          const actionDiv = card.querySelector('.return-actions');
          actionDiv.innerHTML = '<button class="btn btn-secondary btn-return" disabled><i class="bi bi-clock-history me-2"></i>รอแอดมินอนุมัติ</button>';
        }
      } else {
        Swal.fire({
          icon: 'error',
          title: 'ผิดพลาด',
          text: data.message || 'ไม่สามารถขอคืนได้',
          confirmButtonColor: '#dc3545'
        });
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-box-arrow-in-down me-2"></i>ขอคืนอุปกรณ์';
      }
    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'ผิดพลาด',
        text: 'เกิดข้อผิดพลาดขณะขอคืนอุปกรณ์',
        confirmButtonColor: '#dc3545'
      });
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-box-arrow-in-down me-2"></i>ขอคืนอุปกรณ์';
    }
  });
});
</script>

</body>
</html>